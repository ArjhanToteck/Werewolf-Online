<head>
	<style>
		button {
			height: 25;
			width: 105;
		}

		input {
			height: 25;
		}
	</style>
	<title>Werewolf | ArjhanToteck</title>
	<link rel="icon" href="/favicon.png">
	<link href="https://arjhantoteck.vercel.app/style.css" rel="stylesheet" type="text/css" media="all">
</head>

<body>
	<h1 class="glitch" id="heading" data-text="Werewolf">Werewolf</h1>
	<div id="menu">
		<button onclick="startGame()">Host Game</button>
		<button onclick="joinGame()">Join Game</button>
	</div>
	<div id="game" style="display:none;">
		<div id="navbar" class="navbar" style="display:none;">
			<span class="glitch" data-text="Werewolf" text-shadow: 2px #707070;> Werewolf </span>
			<a href="/"><button>Home</button></a>
			<a href="instructions.html"><button>How to Play</button></a>
			<a href="credits.html"><button>Credits</button></a>
		</div>
		<div id="chat"> </div>
		<br>
		<div id="chatInput">
			<input size="35" autocomplete="off" placeholder="Message" autofocus id="messageBox">
			<button onclick="sendMessage()">Send</button>
		</div>
	</div>
</body>

<script>
const server = "werewolf.arjhantoteck.repl.co";
let password;
let gameCode;
let connection;

// checks if previously saved game
if (getCookie("code") != null && getCookie("password") != null) {
	// sets data
	password = getCookie("password");
	gameCode = getCookie("code");

	// sets up connection
	setUpConnection();

	// shows game
	menu.style.display = "none";
	game.style.display = "block";
	heading.innerText = `Werewolf: Game ${gameCode}`;
	heading.dataset.text = `Werewolf: Game ${gameCode}`;

	// adds enter key event listener
	document.addEventListener('keydown', function(event) {
		if (event.key == "Enter") {
			sendMessage();
		}
	});

	// show navbar when scrolled past heading
	window.addEventListener("scroll", function() {
		let elementTarget = document.getElementById("heading");
		if (window.scrollY > (elementTarget.offsetTop + elementTarget.offsetHeight)) {
			document.getElementById("navbar").style.display = "block";
		} else {
			document.getElementById("navbar").style.display = "none";
		}
	});
}

function startGame(name = undefined) {
	if (!name) {
		name = prompt("Enter your username.");
	}

	// creates game and gets code
	fetch(`https://${server}/startGame?name=${encodeURIComponent(name)}`, {
			method: "POST"
		})
		.then(response => {
			if (response.ok) return response.text()

			// alerts user of error
			response.text().then(function(data) {
				alert(data);
			});

			throw new Error("Network response was not ok.")
		})
		.then(function(data) {
			const parsedData = JSON.parse(data);

			// sets password
			document.cookie = `password=${parsedData.password}`;
			password = parsedData.password;

			// sets code
			document.cookie = `code=${parsedData.code}; expires=Thu, 25 Dec 2999 12:00:00 UTC;`
			gameCode = parsedData.code;

			// shows game
			menu.style.display = "none";
			game.style.display = "block";
			heading.innerText = `Werewolf: Game ${gameCode}`;
			heading.dataset.text = `Werewolf: Game ${gameCode}`;

			// adds enter key event listener
			document.addEventListener('keydown', function(event) {
				if (event.key == "Enter") {
					sendMessage();
				}
			})

			setUpConnection();
		}).catch(function() {
			alert("There is some sort of network error. Try connecting to a different server or connecting your device to the internet.");
		});
}

function joinGame(code = prompt("code"), name = undefined) {
	if (!name) {
		name = prompt("Enter your username.");
	}

	fetch(`https://${server}/joinGame?code=${code}&name=${encodeURIComponent(name)}`, {
			method: "POST"
		})
		.then(response => {
			if (response.ok) return response.text()

			// alerts user of error
			response.text().then(function(data) {
				alert(data);
			});

			throw new Error("Network response was not ok.");
		})
		.then(function(data) {
			// sets password
			document.cookie = `password=${data}`;
			password = data;

			// sets code
			document.cookie = `code=${code}; expires=Thu, 25 Dec 2999 12:00:00 UTC;`
			gameCode = code;

			// shows game
			menu.style.display = "none";
			game.style.display = "block";

			// adds enter key event listener
			document.addEventListener('keydown', function(event) {
				if (event.key == "Enter") {
					sendMessage();
				}
			});

			setUpConnection();
		}).catch(function() {
			alert("There is some sort of network error. Try connecting to a different server or connecting your device to the internet.");
		});
}

function setUpConnection() {
	// establishes connection with websocket server
	connection = new WebSocket(`wss://${server}`);

	// waits until connection opened
	connection.addEventListener("open", function(event) {
		console.log("opened");
		connection.send(JSON.stringify({
			password: password,
			code: gameCode,
			action: "linkConnection"
		}));
	});

	// recieve websocket messages
	connection.addEventListener("message", function(event) {
		const message = JSON.parse(event.data);
		handleWebSocketMessage(message);
	});
}

function sendMessage() {
	connection.send(JSON.stringify({
		password: password,
		code: gameCode,
		action: "sendMessage",
		date: new Date().toUTCString(),
		message: messageBox.value
	}));
	messageBox.value = "";
}

function handleWebSocketMessage(message) {
	console.log(message);
	switch (message.action) {
		// recieves chat message
		case "recieveMessage":
			// loops through every sent message
			for (var i = 0; i < message.messages.length; i++) {
				// parses date
				let date = new Date(message.messages[i].date);
				let dateString = `${date.getMonth()}/${date.getDate()}/${date.getYear()}, ${date.getHours() > 12 ? date.getHours() - 12 : date.getHours()}:${date.getMinutes().toString().length == 2 ? date.getMinutes() : "0" + date.getMinutes()} ${date.getHours() > 12 ? "PM" : "AM"}`;

				console.log(message.messages[i].permission);

				let factionMessage = "";

				// not village
				if (message.messages[i].permission != "village") {
					// specific night chat and not with moderator
					if (message.messages[i].permission.substring(0, 5) != "user:") {
						factionMessage = `(To the ${message.messages[i].permission})`;
					} else {
						// privately from moderator
						if (message.messages[i].sender == "Moderator") {
							factionMessage = "(Privately)";
						} else {
							// from player to moderator
							factionMessage = "(To the Moderator)";
						}
					}
				}

				console.log(factionMessage);

				// shows each message
				messageElement = document.createElement("div");
				messageElement.innerHTML = `<span style="background-color: ${message.messages[i].permission == "village" ? "white" : "red"}; color: #262626">NAME (DATE)</span><br><span style="color: ${message.messages[i].permission == "village" ? "white" : "red"};">MESSAGE</span><br><br>`;
				messageElement.childNodes[0].innerText = `${message.messages[i].sender} ${factionMessage} (${dateString})`;
				messageElement.childNodes[2].innerText = `${message.messages[i].message}`;

				// shows message
				chat.appendChild(messageElement);
			}
			break;

			// clears chat
		case "clearChat":
			chat.innerHTML = "";
			connection.close();
			setUpConnection();
			break;

			// game closes
		case "gameClosed":
			alert(message.message);
			location.reload;
			break;
	}
}

function getCookie(name) {
	var cname = name + "=";
	var ca = document.cookie.split(';');
	for (var i = 0; i < ca.length; i++) {
		var c = ca[i];
		while (c.charAt(0) == ' ') {
			c = c.substring(1);
		}
		if (c.indexOf(cname) == 0) {
			return c.substring(cname.length, c.length);
		}
	}
	return undefined;
}
</script>
