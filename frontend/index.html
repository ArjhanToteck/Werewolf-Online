<head>
	<style>
		button {
			height: 25;
			width: 105;
		}

		input {
			height: 25;
		}
	</style>
	<title>Werewolf | ArjhanToteck</title>
	<link rel="icon" href="/favicon.png">
	<link href="https://arjhantoteck.vercel.app/style.css" rel="stylesheet" type="text/css" media="all">
</head>

<body>
	<div id="menu">
		<h1 class="glitch" id="heading" data-text="Werewolf">Werewolf</h1>
		<button onclick="startGame()">Host Game</button>
		<button onclick="joinGame()">Join Game</button>
	</div>
	<div id="game" style="display:none;">
		<div id="chat"> </div>
		<br>
		<div id="chatInput">
			<input size="35" autocomplete="off" placeholder="Message" autofocus id="messageBox">
			<button onclick="sendMessage()">Send</button>
		</div>
	</div>
</body>

<script>
const server = "werewolf.arjhantoteck.repl.co";
let password;
let gameCode;
let connection;
let test;

function startGame(name = undefined) {
	if(!name){
		name = prompt("Enter your username.");
		while (name.includes("/")){
			name = prompt("Your name may not contain a slash.");
		}
	}

	// creates game and gets code
	fetch(`https://${server}/startGame/${name}`, {method: "POST"})
		.then(response => {
			if (response.ok) return response.text()
			throw new Error("Network response was not ok.")
			alert("Network error.")
		})
		.then(function(data){
			const parsedData = JSON.parse(data);

			// sets password
			document.cookie = `password=${parsedData.password}`;
			password = parsedData.password;

			// sets code
			document.cookie = `code=${parsedData.code}; expires=Thu, 25 Dec 2999 12:00:00 UTC;`
			gameCode = parsedData.code;

			// shows game
			menu.style.display = "none";
			game.style.display = "block";

			// adds enter key event listener
			document.addEventListener('keydown', function(event){
				if(event.key == "Enter"){
					sendMessage();
				}
			});

			setUpConnection();
		});
}

function joinGame(code = prompt("code"), name = undefined, spectator = false) {
	if(!name){
		name = prompt("Enter your username.");
		while (name.includes("/")){
			name = prompt("Your name may not contain a slash.");
		}
	}

	fetch(`https://${server}/joinGame/${code}/${name}/${spectator}`, {method: "POST"})
		.then(response => {
			if (response.ok) return response.text()
			alert("Game code is invalid or there is a network error.")
			throw new Error("Network response was not ok.");
		})
		.then(function(data){
			// sets password
			document.cookie = `password=${data}`;
			password = data;

			// sets code
			document.cookie = `code=${code}; expires=Thu, 25 Dec 2999 12:00:00 UTC;`
			gameCode = code;

			// shows game
			menu.style.display = "none";
			game.style.display = "block";

			// adds enter key event listener
			document.addEventListener('keydown', function(event){
				if(event.key == "Enter"){
					sendMessage();
				}
			});

			setUpConnection();
		});
}

function setUpConnection(){
	// establishes connection with websocket server
	connection = new WebSocket(`wss://${server}`);

	// waits until connection opened
	connection.addEventListener("open", function (event) {
		console.log("opened");
		connection.send(JSON.stringify({password: password, code: gameCode, action: "linkConnection"}));
	});

	// recieve messages
	connection.addEventListener("message", function (event) {
    const message = JSON.parse(event.data);

		if(message.action == "recieveMessage"){
			// loops through every sent message
			for(var i = 0; i < message.messages.length; i++){
				// parses date
				let date = new Date(message.messages[i].date);
				let dateString = `${date.getMonth()}/${date.getDate()}/${date.getYear()}, ${date.getHours() > 12 ? date.getHours() - 12 : date.getHours()}:${date.getMinutes()} ${date.getHours() > 12 ? "PM" : "AM"}`;

				// shows each message
				chat.innerHTML += `<span style="background-color: white; color: #262626">${message.messages[i].sender} (${dateString})</span><br>${message.messages[i].contents}<br><br>`;
			}
		}
	});
}

function sendMessage(){
	connection.send(JSON.stringify({password: password, code: gameCode, action: "sendMessage", date: new Date().toUTCString(), message: messageBox.value}));
	messageBox.value = "";
}
</script>
