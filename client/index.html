<head>
	<style>
		button {
			height: 25;
			width: 105;
		}

		input {
			height: 25;
		}
	</style>
	<title>Werewolf | ArjhanToteck</title>
	<link rel="icon" href="/favicon.png">
	<link href="https://arjhantoteck.vercel.app/style.css" rel="stylesheet" type="text/css" media="all">
</head>

<body>
	<h1 class="glitch" id="heading" data-text="Werewolf">Werewolf</h1>
	<div id="menu">
		<br>
		<button onclick="hostGameMenu.style.display = 'block'; joinGameMenu.style.display = 'none'; document.onkeydown = function(event){if(event.key == 'Enter') startGame()};">Host Game</button>
		<button onclick="joinGameMenu.style.display = 'block'; hostGameMenu.style.display = 'none'; document.onkeydown = function(event){if(event.key == 'Enter') joinGame()};">Join Game</button>
		<br>
		<br>
		<div id="hostGameMenu" style="display:none;">
			<input id="hostGameUsername" placeholder="Username">
			<br>
			<span id="hostGameError" style="display:none; color:red;">
				<br>
			</span>
			<br>
			<button onclick="startGame()">Go</button>
		</div>
		<div id="joinGameMenu" style="display:none;">
			<input id="joinGameCode" placeholder="Game Code">
			<input id="joinGameUsername" placeholder="Username">
			<br>
			<span id="joinGameError" style="display:none; color:red;">
				<br>
			</span>
			<br>
			<button onclick="joinGame()">Join</button>
		</div>
	</div>
	<div id="game" style="display:none;">
		<div id="navbar" class="navbar" style="display:none; left: 0px; background-color:#191919;">
			<span class="glitch" style="left: 10px;" data-text="Werewolf"> Werewolf &nbsp;</span>
			<a href="/"><button>Home</button></a>
			<a href="instructions.html"><button>How to Play</button></a>
			<a href="credits.html"><button>Credits</button></a>
		</div>
		<br>
		<br>
		<div id="chat"></div>
		<div id="chatInput">
			<input size="35" autocomplete="off" placeholder="Message" autofocus id="messageBox">
			<button onclick="sendMessage()">Send</button>
		</div>
	</div>
</body>

<script>
const server = "werewolf.arjhantoteck.repl.co";
let password;
let gameCode;
let connection;

// checks if previously saved game
if (getCookie("code") != null && getCookie("password") != null) {
	// sets data
	password = getCookie("password");
	gameCode = getCookie("code");

	// sets up connection
	setUpConnection();

	// shows game
	menu.style.display = "none";
	game.style.display = "block";
	heading.style.display = "none";
	navbar.style.display = "block";

	// adds enter key event listener
	document.addEventListener('keydown', function(event) {
		if (event.key == "Enter") {
			sendMessage();
		}
	});
}

function startGame(name = undefined) {
	document.onkeydown = undefined;

	// sets name
	if (!name) {
		name = hostGameUsername.value;
	}

	let responseOk = true;

	// creates game and gets code
	fetch(`https://${server}/startGame?name=${encodeURIComponent(name)}`, {
			method: "POST"
		})
		.then(response => {
			// checks if response was ok
			responseOk = response.ok;

			return response.text();
		})
		.then(data => {
			// checks if response was ok
			if(responseOk == false){
				// throws recieved data as error
				throw new Error(data);
				return;
			}

			let parsedData = JSON.parse(data);

			// sets password
			document.cookie = `password=${parsedData.password}; expires=Thu, 25 Dec 2999 12:00:00 UTC;`;
			password = parsedData.password;

			// sets code
			document.cookie = `code=${parsedData.code}; expires=Thu, 25 Dec 2999 12:00:00 UTC;`;
			gameCode = parsedData.code;

			// shows game
			menu.style.display = "none";
			game.style.display = "block";
			heading.innerText = `Werewolf: Game ${gameCode}`;
			heading.dataset.text = `Werewolf: Game ${gameCode}`;

			// adds enter key event listener
			document.addEventListener('keydown', function(event) {
				if (event.key == "Enter") {
					sendMessage();
				}
			})

			setUpConnection();
		}).catch(function(error) {
			if(error.message == "Failed to fetch") error.message = "There was a problem connecting to the server. Try connecting to a different server or checking your internet connection.";
      hostGameError.style.display = "block";
			hostGameError.innerHTML = "<br>" + error.message;
    });
}

function joinGame(code = undefined, name = undefined) {
	document.onkeydown = undefined;

	// sets name
	if (!name) {
		name = hostGameUsername.value;
	}

	// sets code
	if (!code) {
		code = joinGameCode.value;
	}

	let responseOk = true;

	fetch(`https://${server}/joinGame?code=${code}&name=${encodeURIComponent(name)}`, {
			method: "POST"
		})
		.then(response => {
			// checks if response was ok
			responseOk = response.ok;

			return response.text();
		})
		.then(function(data) {
			// checks if response was ok
			if(responseOk == false){
				// throws recieved data as error
				throw new Error(data);
				return;
			}

			// sets password
			document.cookie = `password=${data}; expires=Thu, 25 Dec 2999 12:00:00 UTC;`;
			password = data;

			// sets code
			document.cookie = `code=${code}; expires=Thu, 25 Dec 2999 12:00:00 UTC;`;
			gameCode = code;

			// shows game
			menu.style.display = "none";
			game.style.display = "block";
			heading.innerText = `Werewolf: Game ${gameCode}`;
			heading.dataset.text = `Werewolf: Game ${gameCode}`;

			// adds enter key event listener
			document.addEventListener('keydown', function(event) {
				if (event.key == "Enter") {
					sendMessage();
				}
			});

			setUpConnection();
		}).catch(function(error) {
			if(error.message == "Failed to fetch") error.message = "There was a problem connecting to the server. Try connecting to a different server or checking your internet connection.";
      joinGameError.style.display = "block";
			joinGameError.innerHTML = "<br>" + error.message;
    });
}

function setUpConnection() {
	// establishes connection with websocket server
	connection = new WebSocket(`wss://${server}`);

	// waits until connection opened
	connection.addEventListener("open", function(event) {
		console.log("opened");
		connection.send(JSON.stringify({
			password: password,
			code: gameCode,
			action: "linkConnection"
		}));
	});

	// recieve websocket messages
	connection.addEventListener("message", function(event) {
		const message = JSON.parse(event.data);
		handleWebSocketMessage(message);
	});
}

function sendMessage() {
	connection.send(JSON.stringify({
		password: password,
		code: gameCode,
		action: "sendMessage",
		date: new Date().toUTCString(),
		message: messageBox.value
	}));
	messageBox.value = "";
}

function handleWebSocketMessage(message) {
	console.log(message);
	switch (message.action) {
		// recieves chat message
		case "recieveMessage":
			// loops through every sent message
			for (var i = 0; i < message.messages.length; i++) {
				// parses date
				let date = new Date(message.messages[i].date);
				let dateString = `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear().toString().substring(2)}, ${date.getHours() > 12 ? date.getHours() - 12 : date.getHours()}:${date.getMinutes().toString().length == 2 ? date.getMinutes() : "0" + date.getMinutes()} ${date.getHours() > 12 ? "PM" : "AM"}`;

				let factionMessage = "";

				// not village
				if (message.messages[i].permission != "village") {
					// specific night chat and not with moderator
					if (message.messages[i].permission.substring(0, 5) != "user:") {
						factionMessage = `(To the ${message.messages[i].permission})`;
					} else {
						// privately from moderator
						if (message.messages[i].sender == "Moderator") {
							factionMessage = "(Privately)";
						} else {
							// from player to moderator
							factionMessage = "(To the Moderator)";
						}
					}
				}

				console.log(factionMessage);

				// shows each message
				chat.innerHTML += `<div><span style="background-color: ${message.messages[i].permission == "village" ? "white" : "red"}; color: #262626">${message.messages[i].sender} ${factionMessage} (${dateString})</span><br><span style="color: ${message.messages[i].permission == "village" ? "white" : "red"};">${message.messages[i].message}</span><br><br></div>`;

			}
			break;

			// clears chat
		case "clearChat":
			chat.innerHTML = "";
			connection.close();
			setUpConnection();
			break;

			// game closes
		case "gameClosed":
			alert(message.message);
			document.cookie = `code=; expires=Thu, 25 Dec 1999 12:00:00 UTC; password=; expires=Thu, 25 Dec 1999 12:00:00 UTC`;
			location.reload();
			break;
	}
}

function getCookie(name) {
	var cname = name + "=";
	var ca = document.cookie.split(';');
	for (var i = 0; i < ca.length; i++) {
		var c = ca[i];
		while (c.charAt(0) == ' ') {
			c = c.substring(1);
		}
		if (c.indexOf(cname) == 0) {
			return c.substring(cname.length, c.length);
		}
	}
	return undefined;
}
</script>
